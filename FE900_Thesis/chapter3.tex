\chapter{High-Level Architecture of an FPGA Matching Engine}

An FPGA-based matching engine is not a monolithic entity but rather a system of interconnected, highly-specialized modules working in harmony. Figure \ref{fig:matching_engine_arch} illustrates the high-level architecture, showing the data flow from network ingress to egress.

\begin{figure}[h!]
    \centering
    \caption{High-Level Data Flow in an FPGA Matching Engine}
    \label{fig:matching_engine_arch}
    \begin{tikzpicture}[node distance = 1.2cm and 0.8cm]
        % Define Nodes
        \node [block, text width=6em] (net_in) {Network};
        \node [block, text width=6em, right=of net_in] (phy) {PHY Layer};
        \node [block, right=of phy] (mac) {10G Ethernet MAC};
        \node [block, below=of mac] (parser) {Packet Parser};
        \node [block, below=of parser] (orderbook) {Order Book Management};
        \node [block, right=of orderbook] (matcher) {Matching Logic};
        \node [block, below=of orderbook] (execgen) {Execution Report Generator};
        \node [block, below=of execgen] (formatter) {Packet Formatter \& Sender};
        
        % Draw Arrows (Data Flow)
        \path [line] (net_in) -- (phy);
        \path [line] (phy) -- (mac);
        \path [line] (mac) -- (parser);
        \path [line] (parser) -- (orderbook);
        \path [line] (orderbook) -- (matcher);
        \path [line, dashed] (matcher) edge[bend left=10] (orderbook);
        \path [line] (matcher) -- (execgen);
        \path [line] (orderbook) -- (execgen);
        \path [line] (execgen) -- (formatter);
        \path [line] (formatter) -| node[near start, right] {} (mac.south);
        \path [line, dashed] (mac) edge[bend left=10] (phy);
    \end{tikzpicture}
\end{figure}

\section{Description of Key Modules}

The system is composed of several core modules, each designed to perform a specific task with minimal latency.

\begin{description}
    \item[Physical Layer (PHY) \& MAC]
    \textit{Responsibility:} Manages the physical connection to the network, typically via an SFP+ port. The Media Access Control (MAC) core handles low-level Ethernet framing, including preamble generation/checking and CRC checksums. \\
    \textit{Implementation:} This functionality is typically instantiated using pre-verified Intellectual Property (IP) cores provided by the FPGA vendor (e.g., Xilinx or Intel).

    \item[Packet Parser/Decoder]
    \textit{Responsibility:} Inspects incoming Ethernet packets to extract the relevant trading message payload. This involves stripping away the Ethernet, IP, and UDP headers. \\
    \textit{Logic:} The logic must rapidly identify the message type (e.g., New Order, Cancel Order) and extract key fields such as Symbol, OrderID, Price, Quantity, and Side (Buy/Sell). This is achieved through parallel hardware logic that processes the packet as it streams from the MAC.

    \item[Order Book Management]
    \textit{Responsibility:} This is the core stateful component of the system, responsible for maintaining the entire order book for one or more financial instruments. \\
    \textit{Implementation:} To ensure extremely fast access times, the order book is implemented using the FPGA's on-chip memory blocks (BRAMs or URAMs). The hardware logic is designed to:
    \begin{itemize}
        \item Add new orders to the book in the correct price-time priority position.
        \item Remove orders that are cancelled or fully filled.
        \item Modify the quantity of orders that are partially filled.
    \end{itemize}
    The underlying data structure is optimized for parallel hardware access, often using implementations of linked lists or priority queues directly in hardware.

    \item[Matching Logic]
    \textit{Responsibility:} This is the combinatorial heart of the engine. Upon the arrival of a new order from the Packet Parser, the Matching Logic compares it against the top of the Order Book (i.e., the best bid and ask). \\
    \textit{Logic:} The engine strictly enforces a price-time priority algorithm. An incoming buy order is checked against the best ask price, while a sell order is checked against the best bid price. If the prices cross, a match occurs. This logic is heavily pipelined to enable a matching decision within a few clock cycles.

    \item[Execution Report Generator]
    \textit{Responsibility:} When a trade occurs (a "fill") or an order is accepted by the book ("acknowledged"), this module is responsible for generating the appropriate outbound message. \\
    \textit{Logic:} It formats a data payload containing critical information for the trader, such as TradeID, FillPrice, FillQuantity, and the original OrderID.

    \item[Packet Formatter \& Sender]
    \textit{Responsibility:} This module performs the reverse operation of the parser. It takes the application-level payload from the Execution Report Generator and encapsulates it within the necessary UDP, IP, and Ethernet headers. The complete packet is then sent to the Ethernet MAC for transmission onto the network.
\end{description}