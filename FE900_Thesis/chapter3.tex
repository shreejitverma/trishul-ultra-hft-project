\chapter{High-Level Architecture of an FPGA Matching Engine}

An FPGA-based matching engine is not a monolithic entity but rather a system of interconnected, highly-specialized modules working in harmony. Figure \ref{fig:matching_engine_arch} illustrates the high-level architecture, showing the data flow from network ingress to egress.

\begin{figure}[h!]
    \centering
    \caption{High-Level Data Flow in the Implemented FPGA Matching Engine}
    \label{fig:matching_engine_arch}
    \begin{tikzpicture}[node distance = 1.0cm and 0.5cm, auto]
        % Define styles
        \tikzstyle{block} = [rectangle, draw, fill=blue!10, text width=6em, text centered, rounded corners, minimum height=3em]
        \tikzstyle{line} = [draw, -latex', thick]
        \tikzstyle{cloud} = [draw, ellipse, fill=red!10, node distance=2cm, minimum height=2em]
        
        % Nodes
        \node [block] (mac_rx) {MAC RX (AXI-S)};
        \node [block, below=of mac_rx] (parser) {RX Parser (L2/L3/L4)};
        \node [block, below=of parser] (decoder) {ITCH Decoder};
        \node [block, right=of decoder] (book) {Order Book (L1/BBO)};
        \node [block, right=of book] (strategy) {RL Core};
        \node [block, above=of strategy] (encoder) {OUCH Encoder};
        \node [block, above=of encoder] (bridge) {TX Bridge};
        \node [block, left=of bridge] (mac_tx) {MAC TX (AXI-S)};

        % Edges
        \path [line] (mac_rx) -- (parser);
        \path [line] (parser) -- node[midway, right, scale=0.7] {UDP Payload} (decoder);
        \path [line] (decoder) -- node[midway, below, scale=0.7] {Tick (Price/Qty)} (book);
        \path [line] (book) -- node[midway, below, scale=0.7] {BBO State} (strategy);
        \path [line] (strategy) -- node[midway, right, scale=0.7] {Buy/Sell Signal} (encoder);
        \path [line] (encoder) -- node[midway, left, scale=0.7] {OUCH Packet} (bridge);
        \path [line] (bridge) -- (mac_tx);
    \end{tikzpicture}
\end{figure}

\section{Description of Key Modules}

The system is composed of several core modules, each designed to perform a specific task with minimal latency.

\begin{description}
    \item[RX Parser (\texttt{rx\_parser})]
    \textit{Responsibility:} Inspects incoming Ethernet packets to extract the UDP payload containing market data. \\
    \textit{Implementation:} A Finite State Machine (FSM) that tracks byte offsets to strip Ethernet (14 bytes), IP (20 bytes), and UDP (8 bytes) headers, streaming only the payload to the downstream decoder.

    \item[ITCH Decoder (\texttt{itch\_decoder})]
    \textit{Responsibility:} Parses the raw binary payload to identify specific market messages (e.g., "Add Order"). \\
    \textit{Logic:} It accumulates streaming data into a buffer and extracts fixed-width fields (Timestamp, Price, Quantity) once a complete message is received, normalizing them into a unified "Tick" format.

    \item[Order Book (\texttt{book2})]
    \textit{Responsibility:} Maintains the "Best Bid and Offer" (BBO) state in hardware registers. \\
    \textit{Implementation:} Optimized for single-cycle updates. It compares incoming ticks against the current BBO registers and updates them immediately if the new price is more competitive.

    \item[RL Strategy Core (\texttt{strat\_decide})]
    \textit{Responsibility:} The decision-making brain. It replaces static threshold logic with a neural network inference engine. \\
    \textit{Logic:} It computes features (Spread, Imbalance) and uses DSP slices to evaluate a policy function, outputting a trading signal based on learned weights.

    \item[OUCH Encoder (\texttt{order\_encode})]
    \textit{Responsibility:} Formats the internal BUY/SELL signal into a valid NASDAQ OUCH 5.0 binary message. \\
    \textit{Logic:} A state machine constructs a multi-word packet with the required headers, Client Order ID, Price, and Quantity fields, strictly adhering to the Little Endian protocol specification.

    \item[TX Bridge (\texttt{tx\_bridge})]
    \textit{Responsibility:} Adapts the encoder's output to the MAC layer's timing requirements, ensuring valid AXI-Stream handshaking before the packet is placed on the wire.
\end{description}

\section{Software Support Architecture}
While the critical path is in FPGA, the system relies on a robust C++ software architecture for simulation and control (detailed in Chapter 5).
\begin{itemize}
    \item \textbf{Async Logger:} A non-blocking logging infrastructure ensures that debugging and compliance logs do not back-pressure the trading threads.
    \item \textbf{Matching Engine Simulator:} A software-based exchange simulator allows for the verification of the OUCH encoder and strategy logic before hardware deployment.
\end{itemize}
