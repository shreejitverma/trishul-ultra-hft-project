\chapter{High-Level Architecture of the FPGA-Based Matching Engine}

The design of a high-frequency trading (HFT) system requires a rigorous adherence to the principles of determinism and minimal latency. Unlike general-purpose computing architectures, which optimize for average-case throughput, an FPGA-based matching engine must be architected for worst-case execution time. This chapter details the high-level architecture of the proposed system, decomposing it into a pipeline of highly specialized, heterogeneous modules. Figure \ref{fig:matching_engine_arch} illustrates the unidirectional data flow, tracing the lifecycle of a market event from network ingress to trade execution.

\begin{figure}[h!]
    \centering
    \caption{Data Flow Architecture of the FPGA Matching Engine}
    \label{fig:matching_engine_arch}
    \begin{tikzpicture}[node distance = 1.0cm and 0.5cm, auto]
        % Define styles
        \tikzstyle{block} = [rectangle, draw, fill=blue!10, text width=6em, text centered, rounded corners, minimum height=3em]
        \tikzstyle{line} = [draw, -latex', thick]
        \tikzstyle{cloud} = [draw, ellipse, fill=red!10, node distance=2cm, minimum height=2em]
        
        % Nodes
        \node [block] (mac_rx) {MAC RX (AXI-S)};
        \node [block, below=of mac_rx] (parser) {RX Parser (L2/L3/L4)};
        \node [block, below=of parser] (decoder) {ITCH Decoder};
        \node [block, right=of decoder] (book) {Order Book (L1/BBO)};
        \node [block, right=of book] (strategy) {RL Inference Core};
        \node [block, above=of strategy] (encoder) {OUCH Encoder};
        \node [block, above=of encoder] (bridge) {TX Bridge};
        \node [block, left=of bridge] (mac_tx) {MAC TX (AXI-S)};

        % Edges
        \path [line] (mac_rx) -- (parser);
        \path [line] (parser) -- node[midway, right, scale=0.7] {UDP Payload} (decoder);
        \path [line] (decoder) -- node[midway, below, scale=0.7] {Tick (Price/Qty)} (book);
        \path [line] (book) -- node[midway, below, scale=0.7] {BBO State} (strategy);
        \path [line] (strategy) -- node[midway, right, scale=0.7] {Trade Signal} (encoder);
        \path [line] (encoder) -- node[midway, left, scale=0.7] {OUCH Packet} (bridge);
        \path [line] (bridge) -- (mac_tx);
    \end{tikzpicture}
\end{figure}

\section{Modular Design and Functional Decomposition}

The system architecture is predicated on a pipelined design pattern, where each stage performs a discrete transformation on the data stream. This modularity allows for precise timing constraints to be applied to critical paths and facilitates the independent verification of sub-components.

\subsection{Ingress and Protocol Parsing}
The ingress stage is responsible for the line-rate consumption of Ethernet frames.
\begin{description}
    \item[RX Parser (\texttt{rx\_parser}):] This module serves as the gatekeeper of the system. Implemented as a Finite State Machine (FSM), it inspects incoming 64-bit words from the MAC interface. Its primary function is to strip the Ethernet (14 bytes), IPv4 (20 bytes), and UDP (8 bytes) headers. Crucially, it validates the checksums and destination ports in hardware, dropping irrelevant traffic immediately to prevent downstream congestion.
    
    \item[ITCH Decoder (\texttt{itch\_decoder}):] Following header removal, the raw payload is streamed to the protocol decoder. This module parses the NASDAQ ITCH 5.0 binary protocol. It employs a sliding-window buffer to align incoming byte streams and extract semantic fields—specifically Order ID, Price, and Quantity—from "Add Order" (Type 'A') and "Order Executed" (Type 'E') messages. The output is a normalized "Tick" structure, abstracting the specific wire protocol from the rest of the system.
\end{description}

\subsection{State Management and Decision Logic}
The core of the trading engine resides in its ability to maintain state and make decisions based on that state.
\begin{description}
    \item[Order Book Management (\texttt{book2}):] The normalized ticks feed into the hardware Order Book. This module is optimized to maintain the \textbf{Best Bid and Offer (BBO)}---which represents the \textit{"Top of the Pile." It is simply the highest price anyone is currently willing to pay and the lowest price anyone is currently willing to accept.} By maintaining this state in hardware, the system can react to price changes instantaneously.

    \item[Reinforcement Learning Strategy Core (\texttt{strat\_decide}):] This module is the \textit{"Brain"} of the system. Instead of simple, rigid rules, it uses a \textit{trained AI model} to analyze the market and decide whether to buy or sell. By running this AI directly on the FPGA hardware, we get the best of both worlds: adaptive intelligence and lightning-fast speed.
\end{description}

\subsection{Egress and Execution}
Once a trading decision is reached, it must be translated into a valid network packet for the exchange.
\begin{description}
    \item[OUCH Encoder (\texttt{order\_encode}):] This component acts as the protocol bridge for execution. Upon receiving a \texttt{BUY} or \texttt{SELL} signal from the RL Core, it formats a binary order message adhering to the NASDAQ OUCH 5.0 specification. The encoder populates the necessary fields—including the Client Order ID, Price, and Shares—in Little Endian format, packing them into a dense 40-byte packet structure.

    \item[TX Bridge (\texttt{tx\_bridge}):] The final stage of the pipeline adapts the bursty output of the encoder to the strict timing requirements of the 10GbE MAC. It handles AXI-Stream handshaking signals (\texttt{tready}, \texttt{tvalid}) and inserts the necessary inter-frame gaps, ensuring physical layer compliance before the packet is serialized onto the fiber optic medium.
\end{description}

\section{Software Support Architecture}

While the critical path executes entirely within the FPGA fabric, a robust software ecosystem is essential for simulation, model training, and system monitoring.
\begin{itemize}
    \item \textbf{Asynchronous Logging Infrastructure:} To maintain observability without compromising performance, the software layer utilizes a lock-free, ring-buffer-based logging mechanism. This ensures that diagnostic data and compliance logs are offloaded to background threads, preventing I/O blocking on the main control threads.
    \item \textbf{Matching Engine Simulator:} To validate the efficacy of the RL Core and the correctness of the OUCH encoder prior to hardware deployment, a bit-accurate software simulator of the exchange matching logic is employed. This simulator enforces \textbf{Price-Time Priority}---a rule used by exchanges where orders at the same price are filled in the order they were received---allowing for realistic backtesting of the strategy against historical data.
\end{itemize}